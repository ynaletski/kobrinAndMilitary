
    Примерная последовательности действий с контроллером
    системы учета отпуска нефтепродуктов для стояка
    с верхним и нижним типом налива.

-------------------------------

    Контроллер ипользует протокол обмена Modbus RTU.

    Параметры асинхронного последовательного канала связи :
       19200 бод, 8 бит данных, без контроля четности, 1 стоп.бит.
       Физический канал связи RS485.

    Поддерживаются функции Modbus: 3,6,16.

    Каждому контроллеру присваивается собственный адрес в магистрали Modbus.

    В контроллере используется 2 типа регистров:
     - целочисленные (16 бит), далее Int;
     - регистры с плавающей запятой формата IEEE (32 бита), далее Float.

   Регистры типа Int имеют адреса 0...168.
    Один регистр типа Int (16 бит) занимает один адрес в адресном пространстве контроллера.
   Соответственно обозначаются I0...I168. Например:

      I7   Регистр команды
      I8   Регистр состояния
      I10  Регистр ошибок

     Регистры типа Float (32 бита) имеют адреса 1000...1070 .
  Один регистр типа Float занимает 2 адреса в адресном пространстве контроллера.
     Соответственно обозначаются F1000...F1070.
   Для пересылки регистр Float разбивается на 2 регистра по 16 бит.
     Сначала передается младший регистр (D0-D15), затем старший (D16-D31).
   В 16 битном регистре, согласно Modbus, первым передаетя старший байт.

  Данные регистров  доступны по чтению - функция Modbus 03 и записи
   - функции Modbus 06,16.

   Поддерживаются функции Modbus: 3,6,16.
-------------------------------

 !!!  Структуру адресов и битовую кодировку всех  регистров,
  упоминаемых ниже   См. Регистры.txt.


1.   Отпуск нефтепродуктов при верхнем наливе.

    Принятые сокращения:

    АСН - Автоматизированный Стояк Налива
    ВРФ - Вычислитель Расхода многоФункциональный
    УЗА - Устройство Заземления Автоцистерны

1.1. Контроль состояния узла налива.
    До начала отпуска нефтепродукта следует проконтролировать состояние
   узла налива и в случае невозможности отпуска нефтепродуктов выдать
   соответствующее сообщение оператору.

 1.1.1.  Необходимо проконтролировать регистры ошибок I10,I11,I12.
   При ненулевом значении I10 отпуск невозможен, необходимо вывести сообщение
    оператору с информацией об ошибке. (См. Регистры.txt).
   При наличии ошибок, по команде оператора можно очистить регистры ошибок
 командой

>>>>  I7=5;

   Если причина ошибки не устранена, код ошибки будет снова установлен
 в регистре ошибок.


 1.1.2.  Необходимо проконтролировать регистр состояния I8.
        Отпуск может быть начат при значении I8=-1,0,10; Т.е. если отпуск
      в данный момент не выполняется.

 1.1.3.  Необходимо проконтролировать сигналы узла верхнего налива.
    Контроль состояния узла верхнего налива осуществляется по следующим
  сигналам:

 I21 - регистр дискретных входов , соответствие бит сигналам:


D0 = 1    - резерв
D1 = 1    - резерв
D2 = 1    - резерв
D3 = 1    - резерв

D4 = 1    - резерв
D5 = 1    - резерв
D6 = 0
D7 = 1    - резерв

D8 = 1    - резерв
D9 = 1    - резерв
D10  - задвижка верхнего налива закрыта    1 - закрыта
D11  - задвижка нижнего налива закрыта     1 - закрыта


   В состоянии установки готовом к отпуску значение
   (I21 & 0xc00)  == 0xc00 ;

   Если какой либо из битов = 0, будет зафиксирована соответствующая ошибка,
 которая запретит прием команды старт отпуска.
   При этом соответствующее сообщение будет выведено на дисплей ВРФ.

1.2. Задание дозы отпуска.

   Необходимо задать объем дозы отпуска .

   Доза в литрах должна быть записана в  регистр  операнда -  F1000,тип float.
   Например, если требуется отпустить 8000 л:

   Следует записать через Modbus в регистр следующее значение:

>>>>  F1000 = 8000;

1.3. Задание параметров отпуска.

   При верхнем наливе струя нефтепродукта падает в автоцистерну, при этом
  происходит электризация нефтепродукта статическим зарядом.
   С целью снижения уровня  электризации нефтепродукта и автоцистерны
  отпуск осуществляется с пониженным (начальным) расходом до момента погружения рукава
  рукава (торца консоли) в нефтепродукт. Затем отпуск осуществляется
 с номинальным расходом.

   Объем цистерны до уровня погружения рукава,л , начальный и
 номинальный расход зависят от типа автоцистерны и должны быть
 заданы соответственно.

  Указанным параметрам соответствуют регистры верхнего налива:

F1004    объем цистерны до уровня погружения рукава,л
F1048    Расход начальный, л/с
F1050    Расход номинальный, л/с

  Например , для используемой автоцистерны объем цистерны до уровня погружения
 рукава составляет 500 л, начальный расход 10000 кг/ч, номинальный
 расход - 70000 кг/ч.

   Следует записать через Modbus в регистры следующие значения:

>>>>  F1004 = 500;
>>>>  F1048 = 10000;
>>>>  F1050 = 70000;

1.4. Посылка команды "Старт отпуска,верхний налив ".

   Необходимо послать команду "Старт верхнего налива по объему"
   Для этого в регистр I7 следует записать значение 201.

>>>>  I7=201;

    Если  в момент записи по Modbus в регистр I7 значения =201 :

     - регистр ошибки I10 не равен 0;
     - выполняется отпуск в автоцистерну;
     - доза отпуска  == 0;

    то в ответ по Modbus будет передано сообщение об ошибке
   (исключении) с кодом  исключения 03 - "Запрещенное значение данных",
   что означает  невозможность выполнения команды в данный момент.

    Если команда может быть выполнена (ответ по Modbus нормальный),
 значение регистра операнда F1002 переписываются в регистр копии операнда
 F1002, регистр  операнда  F1000 обнуляется.

  Т.е. в случае успешного приема команды, регистры для приведенного
  примера будут иметь значения:

  F1000   0

  F1002   8000

1.5. Ожидание нажатия кнопки 'Пуск'  верхнего налива.

     После приема команды старта отпуска,
   заданная доза отпуска отображается на терминале ВРФ, при этом
   осуществляется проверка состояния условий , перечисленных в п.1.1.1,
  п.1.1.3.

   При невыполнении любого  из условий, ожидание нажатия на кнопку
 'Пуск' прерывается и  в регистре ошибок записывается код соответствующей
 ошибки.
   В регистр состояния будет записано значение -1.

   Отпуск начнется после нажатия оператором кнопки 'Пуск' верхнего налива.

   В данной версии имитируется постоянное нажатие кнопки "Пуск" верхнего налива.

1.6. Отпуск дозы.

 Состояние процесса отпуска содержится в регистре I8.

 При отпуске контроллером осуществляется проверка состояния
 условий, перечисленных в п.1.1.1.

 При невыполнении любого  из условий отпуск прерывается и
 в регистрах ошибок записывается код ошибки, вызвавшей останов отпуска.

     Текущее количество нефтепродукта, отпускаемого в данной операции содержится
  в регистрах  F1022, F1032 :

 F1022     Масса в текущей операции отпуска,кг.
 F1032     Объем в текущей операции отпуска,л.

     Текущие состояния процесса отпуска - непосредственные данные
 из расходомера  :

 F1020     Масса инвентарная ( накапливающий счетчик),кг
 F1022     Масса в текущей операции отпуска ,кг
 F1024     Массовый расход, кг/ч
 F1026     Плотность кг/м3
 F1028     Температура продукта,C
 F1030     Объем инвентарный ( накапливающий счетчик),л
 F1032     Объем в текущей операции отпуска ,л
 F1034     Объемный расход, л/ч

          Данные аналоговых датчиков
 F1038     температура по внешнему датчику, C
 F1040     давление по внешнему датчику, МПа

    После завершения отпуска (I8 == 10):

    Фактически отпущенное количество нефтепродукта в данной операции
 содержится в регистрах  F1022, F1032
 F1022     Масса,кг
 F1032     Объем,л

  Результирующее значение средней плотности и средней температуры отпущенного
 нефтепродукта содержится в регистрах  F1014,F1016.

 F1014    Температура отпущенного нефтепродукта,C
 F1016    Плотность отпущенного нефтепродукта,кг/м3

  Дополнительные данные в регистрах F1008,F1010,F1012 :

 1008    Референсная температура,C (15)
 1010    Плотность отпущенного нефтепродукта,кг/м3, приведенная к референсной
         температуре
 1012    Объем отпущенного нефтепродукта,л, приведенный к референсной
        температуре


  После отпуска заданной дозы, отпуск будет остановлен автоматически.

   Отпуск прекратится:

  - при возникновении ошибки функционирования (разрыв цепей безопасности,
          аппаратный отказ модулей,нарушение линий связи и т.п.);
  - при исчезновении сигнала УЗА ;
  - при нажатии на кнопку аварийного останова ;
  - при достижении предельного уровня наполнения любой из секций автоцистерны.

   В данной версии имитируется постоянное присутствие разрешающих
 уровней сигналов цепей безопасности, УЗА, кнопок аварийного останова.

  При этом соответствующий бит будет установлен в регистре ошибок I10,I11,I12.

  При необходимости остановить отпуск до завершения отпуска заданной дозы,
  необходимо послать команду:
    I7=2; - Останов отпуска.
   При этом клапаны и насос будут выключены в нужной последовательности
 для предотвращения гидравлического  удара.

   При необходимости экстренного останова отпуска до завершения
 отпуска заданной дозы, необходимо послать команду:
  I7=3   Аварийный останов отпуска,верхний налив.
  При этом задвижки и насос будут выключены незамедлительно.

1.7. Результат отпуска.
     После завершения отпуска I8 (регистр состояния отпуска)
   примет значение 10.  Это указывает на то, что заданная доза или только
   часть дозы была отпущена. При досрочном завершении отпуска будет установлен
   соответствующий бит в регистрах ошибок I10,I11,I12.

  При этом фактически отпущенное количество нефтепродукта в последней
 операции отпуска содержится в следующих регистрах:

F1022    Масса в текущей операции отпуска,кг
F1032    Объем в текущей операции отпуска,л
F1014    Средняя температура отпущенного нефтепродукта,C
F1016    Средняя плотность отпущенного нефтепродукта, кг/м3

1.8. Продолжение отпуска при  досрочном завершении отпуска.

   При досрочном завершении отпуска , например, при получении команды останова,
 при разрыве цепи заземления или при нажатии на кнопку аварийного останова ,
 бывает целесообразно продолжить прерванный процесс отпуска.
   Для продолжения необходимо повторить пп. 1.2, .

 В п.1.2. следует повторить задание дозы, например, если был досрочно остановлен
отпуск из примера п.1.2. следует (несмотря на то, что часть дозы уже отпущена )
вновь задать :

>>>>  F1000 = 8000;

  далее

   Необходимо послать команду   "Продолжение  верхнего налива по объему"
   Для этого в регистр I7 следует записать значение 211.

>>>>  I7=211;

    Если  в момент записи по Modbus в регистр I7 значения =211 :

     - регистр ошибки I10 не равен 0;
     - выполняется отпуск в автоцистерну;
     - доза отпуска  == 0;

    то в ответ по Modbus будет передано сообщение об ошибке
   (исключении) с кодом  исключения 03 - "Запрещенное значение данных",
   что означает  невозможность выполнения команды в данный момент.

    Если команда может быть выполнена (ответ по Modbus нормальный),
 значение регистра операнда F1000 переписываются в регистр копии операнда
 F1002, регистр  операнда  F1000 обнуляется.

  Т.е. в случае успешного приема команды, регистры для приведенного
  примера будут иметь значения:

  F1000   0

  F1002   8000

  далее процесс будет протекать согласно пп.1.5...1.7.

   При этом начальное заполнение будет осуществляться корректно - с учетом
  фактического наполнения автоцистерны.


2.   Отпуск нефтепродуктов при нижнем наливе.

    Принятые сокращения:

    АСН - Автоматизированный Стояк Налива
    ВРФ - Вычислитель Расхода многоФункциональный
    УЗА - Устройство Заземления Автоцистерны

2.1. Контроль состояния узла налива.
    До начала отпуска нефтепродукта следует проконтролировать состояние
   узла налива и в случае невозможности отпуска нефтепродуктов выдать
   соответствующее сообщение оператору.

 2.1.1.  Необходимо проконтролировать регистры ошибок I10,I11,I12.
   При ненулевом значении I10 отпуск невозможен, необходимо вывести сообщение
    оператору с информацией об ошибке. (См. Регистры.txt).
   При наличии ошибок, по команде оператора можно очистить регистры ошибок
 командой

>>>>  I7=5;

   Если причина ошибки не устранена, код ошибки будет снова установлен
 в регистре ошибок.


 2.1.2.  Необходимо проконтролировать регистр состояния I8.
        Отпуск может быть начат при значении I8=-1,0,10; Т.е. если отпуск
      в данный момент не выполняется.

 2.1.3.  Необходимо проконтролировать сигналы узла нижнего налива.
    Контроль состояния узла нижнего налива осуществляется по следующим
  сигналам:

 I21 - регистр дискретных входов , соответствие бит сигналам:


D0 = 1    - резерв
D1 = 1    - резерв
D2 = 1    - резерв
D3 = 1    - резерв

D4 = 1    - резерв
D5 = 1    - резерв
D6 = 0
D7 = - контроллер ограничения наполнения нижнего налива, 1 - ok

D8 = 1    - резерв
D9 = 1    - резерв
D10  - задвижка верхнего налива закрыта    1 - закрыта
D11  - задвижка нижнего налива закрыта     1 - закрыта


   В состоянии установки готовом к отпуску значение
   (I21 & 0xc80)  == 0xc80 ;

   Если какой либо из битов 0x800 или 0x400 будет  = 0, будет зафиксирована
 соответствующая ошибка, которая запретит прием команды старт отпуска.


   Если бит 0x80 будет = 0 при получении команды "старт отпуска",
 будет установлена соответствующая ошибка , и состояние I8=-1;
   При этом соответствующее сообщение будет выведено на дисплей ВРФ.
  В регистре регистре I10 будет установлен бит 0x100.

 ( I10 = 0x0100  - зафиксирован предельный уровень в бензовозе при отпуске).


2.2. Задание дозы отпуска.

   Необходимо задать объем дозы отпуска .

   Доза в литрах должна быть записана в  регистр  операнда -  F1000,тип float.
   Например, если требуется отпустить 8000 л:

   Следует записать через Modbus в регистр следующее значение:

>>>>  F1000 = 8000;


2.3. Посылка команды "Старт нижнего налива по объему".

   Необходимо послать команду "Старт нижнего налива по объему".
   Для этого в регистр I7 следует записать значение 101.

>>>>  I7=101;

    Если  в момент записи по Modbus в регистр I7 значения =101 :

     - регистр ошибки I10 не равен 0;
     - выполняется отпуск в автоцистерну;
     - доза отпуска  == 0;

    то в ответ по Modbus будет передано сообщение об ошибке
   (исключении) с кодом  исключения 03 - "Запрещенное значение данных",
   что означает  невозможность выполнения команды в данный момент.

    Если команда может быть выполнена (ответ по Modbus нормальный),
 значение регистра операнда F1002 переписываются в регистр копии операнда
 F1002, регистр  операнда  F1000 обнуляется.

  Т.е. в случае успешного приема команды, регистры для приведенного
  примера будут иметь значения:

  F1000   0

  F1002   8000

2.4. Ожидание нажатия кнопки 'Пуск'  нижнего налива.

     После приема команды старта отпуска,
   заданная доза отпуска отображается на терминале ВРФ, при этом
   осуществляется проверка состояния условий , перечисленных в п.1.1.1
   и  п.1.1.3.

   При невыполнении любого  из условий, ожидание нажатия на кнопку
 'Пуск' прерывается и  в регистре ошибок записывается код соответствующей
 ошибки.
   В регистр состояния I8 будет записано значение -1.

   Отпуск начнется после нажатия оператором кнопки 'Пуск' нижнего налива.

   В данной версии имитируется постоянное нажатие кнопки "Пуск" нижнего налива.

2.5. Отпуск дозы.

 Состояние процесса отпуска содержится в регистре I8.

 При отпуске контроллером осуществляется проверка состояния
 условий, перечисленных в п.2.1.1   и  сигнала контроллера ограничения
 наполнения нижнего налива.

 При невыполнении любого  из условий отпуск прерывается и
 в регистрах ошибок записывается код ошибки, вызвавшей останов отпуска.

     Текущее количество нефтепродукта, отпускаемого в данной операции содержится
  в регистрах  F1022, F1032 :

 F1022     Масса в текущей операции отпуска,кг.
 F1032     Объем в текущей операции отпуска,л.

     Текущие состояния процесса отпуска - непосредственные данные
 из расходомера  :

 F1020     Масса инвентарная ( накапливающий счетчик),кг
 F1022     Масса в текущей операции отпуска ,кг
 F1024     Массовый расход, кг/ч
 F1026     Плотность кг/м3
 F1028     Температура продукта,C
 F1030     Объем инвентарный ( накапливающий счетчик),л
 F1032     Объем в текущей операции отпуска ,л
 F1034     Объемный расход, л/ч

          Данные аналоговых датчиков
 F1038     температура по внешнему датчику, C
 F1040     давление по внешнему датчику, МПа

    После завершения отпуска (I8 == 10):

    Фактически отпущенное количество нефтепродукта в данной операции
 содержится в регистрах  F1022, F1032
 F1022     Масса,кг
 F1032     Объем,л

  Результирующее значение средней плотности и средней температуры отпущенного
 нефтепродукта содержится в регистрах  F1014,F1016.

 F1014    Температура отпущенного нефтепродукта,C
 F1016    Плотность отпущенного нефтепродукта,кг/м3

  Дополнительные данные в регистрах F1008,F1010,F1012 :

 1008    Референсная температура,C (15)
 1010    Плотность отпущенного нефтепродукта,кг/м3, приведенная к референсной
         температуре
 1012    Объем отпущенного нефтепродукта,л, приведенный к референсной
        температуре


  После отпуска заданной дозы, отпуск будет остановлен автоматически.

   Отпуск прекратится:

  - при возникновении ошибки функционирования (разрыв цепей безопасности,
          аппаратный отказ модулей,нарушение линий связи и т.п.);
  - при исчезновении сигнала УЗА ;
  - при нажатии на кнопку аварийного останова ;
  - при достижении предельного уровня наполнения любой из секций автоцистерны.

   В данной версии имитируется постоянное присутствие разрешающих
 уровней сигналов цепей безопасности, УЗА, кнопок аварийного останова.


  При этом соответствующий бит будет установлен в регистре ошибок I10,I11,I12.

  При необходимости остановить отпуск до завершения отпуска заданной дозы,
  необходимо послать команду:
    I7=2; - Останов отпуска.
   При этом клапаны и насос будут выключены в нужной последовательности
 для предотвращения гидравлического  удара.

   При необходимости экстренного останова отпуска до завершения
 отпуска заданной дозы, необходимо послать команду:
  I7=3   Аварийный останов отпуска,верхний налив.
  При этом задвижки и насос будут выключены незамедлительно.

2.6. Результат отпуска.
     После завершения отпуска I8 (регистр состояния отпуска)
   примет значение 10.  Это указывает на то, что заданная доза или только
   часть дозы была отпущена. При досрочном завершении отпуска будет установлен
   соответствующий бит в регистрах ошибок I10,I11,I12.

  При этом фактически отпущенное количество нефтепродукта в последней
 операции отпуска содержится в следующих регистрах:

F1022    Масса в текущей операции отпуска,кг
F1032    Объем в текущей операции отпуска,л
F1014    Средняя температура отпущенного нефтепродукта,C
F1016    Средняя плотность отпущенного нефтепродукта, кг/м3

2.7. Продолжение отпуска при  досрочном завершении отпуска.

   При досрочном завершении отпуска , например, при получении команды останова,
 при разрыве цепи заземления или при нажатии на кнопку аварийного останова ,
 бывает целесообразно продолжить прерванный процесс отпуска.
   Для продолжения необходимо повторить пп. 2.2, .

 В п.2.2. следует повторить задание дозы, например, если был досрочно остановлен
отпуск из примера п.2.2. следует (несмотря на то, что часть дозы уже отпущена )
вновь задать :

>>>>  F1000 = 8000;

  далее

   Необходимо послать команду   Продолжение  нижнего налива по объему"
   Для этого в регистр I7 следует записать значение 111.

>>>>  I7=111;

    Если  в момент записи по Modbus в регистр I7 значения =111 :

     - регистр ошибки I10 не равен 0;
     - выполняется отпуск в автоцистерну;
     - доза отпуска  == 0;

    то в ответ по Modbus будет передано сообщение об ошибке
   (исключении) с кодом  исключения 03 - "Запрещенное значение данных",
   что означает  невозможность выполнения команды в данный момент.

    Если команда может быть выполнена (ответ по Modbus нормальный),
 значение регистра операнда F1000 переписываются в регистр копии операнда
 F1002, регистр  операнда  F1000 обнуляется.

  Т.е. в случае успешного приема команды, регистры для приведенного
  примера будут иметь значения:

  F1000   0

  F1002   8000

  далее процесс будет протекать согласно пп.2.5...2.6.

==============================================================================
