

   Контроллер системы учета отпуска нефтепродуктов.


   Поддерживаются функции Modbus: 3,6,16.


   Список регистров.


Регистры Int. Адреса в магистрали Modbus : 0...
               REG0...
   Один регистр занимает один адрес.

Адрес       Описание регистра

  0      количество регистров типа  int
  1      количество регистров типа  float

  2      Переключатель меню ВРФ.
  3      Переключатель процесса отпуска.

  4       Версия ПО ,  6 ASCII символов
  5       Версия ПО
  6       Версия ПО

  7       CMD_REG  - регистр команды, в него записывается команда, см. ниже

  8       Состояние отпуска
          -1 - ошибка при приеме команды старта отпуска
           0 - отпуск остановлен до нажатия кнопки "Пуск"
           1 - команда старта отпуска принята успешно,
                 ожидание нажатия кнопки "Пуск".
           2 - отпуск в процессе выполнения
           5 - останов отпуска (клапаны закрыты), ожидание прекращения потока
          10 - отпуск завершен

  9       Код последнего события записанного в журнал
 10       Флаг ошибки, 0 - OK

 11       Код ошибки функционирования (см.ниже)
 12       Расширение кода ошибки функционирования (см.ниже)

 13       регистр ошибок драйвера MVD   ( расходомер Micro Motion)
 14       регистр ошибок драйвера 7060  ( дискретный ввод-вывлд)
 15       регистр ошибок драйвера 7017  ( аналоговый ввод)
 16       регистр ошибок драйвера DELTA ( электропривод насоса)

 17       Период сторожевого таймера Host,ms
          0 - таймер отключен
 18
 19       подтверждение старта без кнопки = Strt_cmd(0x55=85d)
 20

 21      регистр дискр.входов
 22      регистр дискр.выходов

-----------------------------------
          Переменные привода DELTA

 23      регистр состояния DELTA
 24      регистр ошибок привода DELTA
 25      ток в моторе

 26      тек.знач. частоты  привода  ,0.01 Гц
 27      тек.знач. времени разгона   ,0.1 сек
 28      тек.знач. времени замедления,0.1 сек

 29      нач.знач. частоты привода  , 0.01 Гц
 30      нач.знач. времени разгона  ,  0.1 сек
 31      нач.знач. времени замедления ,0.1 сек
---------------------------------------
 32      тип кодировки float (аналогичен рег. 521 Micro Motion,Byte order code for float registers)
         // регистры 7060

 33       Выходы 7060
 34       Входы  7060
 35      регистр ошибки расходомера Micro Motion (регистр I419 , p.148 ).
 36      тип нефтепродукта  1 - товарная нефть, 2 - диэтопливо
                 3 - реактивное топливо, 4 - керосин
                 5 - бензин, 6 - смазочное масло

 37       режим управл.давлением, 1 - стабилизация давления на уровне F1042
                                  0 - частота двигателя насоса равна  F1044
===============================================================================

Регистры Float. Адреса в магистрали : 1000 ...
                Один регистр занимает 2 адреса.
                F1000 ...Fxxxx

Адрес       Описание регистра

 1000    операнд команды
 1002    копия операнда

 1004    объем цистерны до уровня погружения рукава,л

 1006    минимальное давление МПа, при котором возможно увеличить степень
         открытия вентиля

         Результат отпуска дополнительный:

 1008    Референсная температура,C (15)
 1010    Плотность отпущенного нефтепродукта, приведенная к референсной
           температуре
 1012    Объем отпущенного нефтепродукта, приведенный к референсной
        температуре


         Результат отпуска для накладной (обязательные данные):

 1014    Температура отпущенного нефтепродукта
 1016    Плотность отпущенного нефтепродукта

 1018    резервная переменная

         Данные из расходомера
                                                                  Регистр
                                                                 Micro Motion
 1020     Масса инвентарная ( накапливающий счетчик) Mass inventory ,I263
 1022     Масса в текущей операции отпуска (total)   Mass total     ,I259
 1024     Массовый расход, кг/ч                      Mass flow      ,I247
 1026     Плотность кг/м3                            Density        ,I249
 1028     Температура,C                              Temperature    ,I251
 1030     Объем инвентарный ( накапливающий счетчик) Volume invntory,I265
 1032     Объем в текущей операции отпуска (total)
 1034     Объемный расход, л/ч
 1036     Резерв

          Данные аналоговых датчиков

 1038     температура по внешнему датчику, C
 1040     давление по внешнему датчику, МПа

 1042     Заданное давление 10000 = 1 МПа
 1044     Частота насоса max, Гц
 1046     Частота насоса min, Гц
 1048     Расход начальный, л/с
 1050     Расход номинальный, л/с
 1052     Расход замедления  , л/с
 1054     Расход замедления 1, л/с
 1056     Расход замедления 2, л/с
 1058     Частота обмена по Modbus, бод
          I0007 = 7; - установить частоту, после изменения F1058
=============================================

 Перечень команд .

  Для старта команды , необходимо записать код команды в регистр
 команды , т.е.  по адресу 07.

 Код команды

       1       Старт отпуска.

       2       Останов отпуска.

       3       Аварийный останов отпуска - мгновенное  обесточивание клапанов
                и мотора насоса.
       4       Сброс контроллера (аналогичен выкл. и затем вкл.)
       5       Сброс ошибок контроллера.
       6       Запись параметров контроллера в EEPROM.
               Все сохраняемые параметры записываются в EEPROM,
             в том числе значение регистра с адресом 32.
        7      установить скорость обмена по Modbus согласно F1058
       17      перейти в режим командной строки

=========================================

     Состояние сигналов датчиков и аварийной кнопки доступно в регистре REG21,
  соответствие бит сигналам  см.ниже.


    До старта команды отпуска, масса отпуска должна быть записана в регистр
  операнда - по адресу 1000 (F1000), тип float.

     Последовательность байт регистра  'float'  в посылке по MODBUS
  определяется значением регистра Int с адресом 32 - тип кодировки float
  (аналогичен рег. 521 Micro Motion,Byte order code for float registers).
    Значение регистра с адресом 32 сохраняется в EEPROM при поступлении
  соответствующей команды ( и затем инициализируется установленным значением
  после включения питания).

     После приема команды отпуска,т.е. записи значения 1 в регистр с адресом 07
    ( REG7=1;)

     значение регистра операнда переписывается
  в регистр копии операнда с адресом 1002 - (F1002), регистр операнда
  обнуляется.    F1002=F1000; F1000=0;

     Состояние процесса отпуска содержится в регистре с адресом 8 (REG8).
   (См.выше).

     Отпуск начнется после приема команды старта отпуска,  при нажатии
  на кнопку "Пуск".

     Для иммитации нажатия кнопки "Пуск"  (для отладки, например),
  следует записать в регистр с адресом 19  подтверждение старта без
  кнопки - значение 0x55 (85d). REG19=0x55;
    При этом произойдет однократный  запуск процесса отпуска.


     Текущее количество нефтепродукта, отпущенного в данной операции содержится
  в регистрах  F1022, F1032 (см.выше) :

 1022     Масса в текущей операции отпуска (total)
 1032     Объем в текущей операции отпуска (total)

     Текущие состояния процесса отпуска - непосредственные данные
 из расходомера  :

 1020     Масса инвентарная ( накапливающий счетчик) Mass inventory ,I263
 1022     Масса в текущей операции отпуска (total)   Mass total     ,I259
 1024     Массовый расход, кг/ч                      Mass flow      ,I247
 1026     Плотность кг/м3                            Density        ,I249
 1028     Температура,C                              Temperature    ,I251
 1030     Объем инвентарный ( накапливающий счетчик) Volume invntory,I265
 1032     Объем в текущей операции отпуска (total)
 1034     Объемный расход, л/ч

          Данные аналоговых датчиков
 1038     температура по внешнему датчику, C
 1040     давление по внешнему датчику, МПа

    После завершения отпуска (REG8 == 10):

    Фактически отпущенное количество нефтепродукта в данной операции
 содержится в регистрах  F1022, F1032
 1022     Масса
 1032     Объем

  Результирующее значение средней плотности и средней температуры отпущенного
 нефтепродукта содержится в регистрах  1014,1016.

 1014    Температура отпущенного нефтепродукта
 1016    Плотность отпущенного нефтепродукта

  Дополнительные данные в регистрах 1008,1010,1012 :

 1008    Референсная температура,C (15)
 1010    Плотность отпущенного нефтепродукта, приведенная к референсной
           температуре
 1012    Объем отпущенного нефтепродукта, приведенный к референсной
        температуре

=====================================================================================

 Кодировка ошибок функционирования:

REG 11
   0x1             Ошибка CRC EEPROM процессора
   0x2             Ошибка стирания FLASH
   0x4             Ошибка записи во FLASH
   0x8             Расходомер не заполнен -- здесь не используется
   0x10            Расходомер не обнулил массу/объем
   0x20            Нет обновл.данных для журнала
   0x40            Недолив больше допустимого  -- здесь не используется
   0x80            Перелив больше допустимого  -- здесь не используется
   0x000           Насос отключен при отпуске
   0x200           Сторожевой таймер HOST
   0x400           Поток прекратился
   0x800           Нажата аварийная кнопка (ES) при отпуске
   0x2000          Нет связи с расходомером
   0x4000          Ошибка конфигурирования расходомера при включении
   0x0100          Ошибка привода насоса при торможении
   0x0201          Останов привода насоса при отпуске
   0x101           Авария от HOST
   0x401           Драйверы MVD,7060 не включены

При  REG11=1000,
    REG12:
         2         Нет УЗА при отпуске
         3         Уровень в автоцистерне выше допустимого
         6         Консоль не в раб.позиции
         7         Трап не в раб.позиции
         8         Некорректный ID процессора


REG13...REG16  Для соответствующих периферийных устройств:
   1               Ошибка чтения устройства
   2               Ошибка записи в устройство
   4               Ошибка Watch Dog
   8               Ошибка в устройстве, код ошибки устройства в старшем байте


=====================================================================================

 REG 21 соответствие бит сигналам:

D0   - датчик уровня,   1 - ok
D1   - УЗА,             1 - ok
D2   - кнопка "Start",  1 - кнопка нажата
D3   - Аварийная кнопка 0 - кнопка нажата, 1 - ok
D4   - консоль,         1 - ok
D5   - трап,            1 - ok
D6 = 0
D7 = 1

   В состоянии установки готовом к отпуску значение REG21 = 0xbb;
   Если какой-либо из битов = 0 при получении команды "старт отпуска",
 будет установлена соответствующая ошибка , и состояние REG8=-1;
   При этом соответствующее сообщение будет выведено на дисплей ВРФ.

=====================================================================================
